<html>
<head>
	<title>GDS Direct Plus</title>
	<meta charset="utf-8"/>
	<link rel="shortcut icon" href="favicon.png">
</head>
<body style="margin: 0px">

<div id="terminalContext" style="height: 100%;"></div>

<script src="src/actions/initAuthPage.js"></script>
<script src="terminal-bundle.js"></script>
<script>
	window.GdsDirectPlusPage.whenEmcSessionId.then(emcSessionId => {
		let isDev = !(window.location.hostname + '').endsWith('.asaptickets.com');
		window.InitGdsDirectPlusApp({
			htmlRootDom		: document.getElementById('terminalContext'),
			emcSessionId    : emcSessionId,
			cmsUrl			: isDev
				? 'http://cms.gitlab-runner.snx702.dyninno.net'
				: 'https://cms.asaptickets.com',
			PqPriceModal	: (pqData, closeModal, importPq) => {
				console.log('getPqItinerary data', pqData);
				importPq().then(fullData => {
					console.log('importPq data', fullData);
				});
				setTimeout(closeModal, 2000);
			},
		}).then(nodeApp => {
			// nodeApp.runPnr({pnrCode: 'QWE123'});
			// nodeApp.rebuild({data: {itineraryId: 1234, segmentStatus: 'GK'}});
		}).catch(exc => {
			// remove expired token
			document.cookie = 'emcSessionId=';
			window.GdsDirectPlusPage.redirectToLoginPage();
			return Promise.reject(exc);
		});
	});
</script>

<div style="display: none">
	<button onclick="window.updateHighlightRulesFromProd()">Update Highlight Rules From Prod</button>
	<div class="multi-threading-test-output" style="background-color: white; color: black; min-height: 200px;"></div>
</div>
<script>
	window.updateHighlightRulesFromProd = () => {
		let destinationUrl = '/admin/updateHighlightRules';
		let promises = [
			fetch('https://cms.asaptickets.com/admin/terminal/highlight?draw=1&length=5000', {credentials: 'include'}),
			fetch('https://cms.asaptickets.com/admin/table/listGet', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, credentials: 'include', body: 'draw=1&length=5000&order[0][column]=0&order[0][dir]=DESC&model=App\\Models\\Gds'}),
			fetch('https://cms.asaptickets.com/admin/table/listGet', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, credentials: 'include', body: 'draw=1&length=5000&order[0][column]=0&order[0][dir]=DESC&model=App\\Models\\Terminal\\TerminalInputLanguages'}),
			fetch('https://cms.asaptickets.com/admin/table/listGet', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, credentials: 'include', body: 'draw=1&length=5000&order[0][column]=0&order[0][dir]=DESC&model=App\\Models\\Terminal\\TerminalHighlightGroup'}),
			fetch('https://cms.asaptickets.com/admin/table/listGet', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, credentials: 'include', body: 'draw=1&length=5000&order[0][column]=0&order[0][dir]=DESC&model=App\\Models\\Terminal\\TerminalColors'}),
			fetch('https://cms.asaptickets.com/admin/table/listGet', {method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, credentials: 'include', body: 'draw=1&length=5000&order[0][column]=0&order[0][dir]=DESC&model=App\\Models\\Terminal\\TerminalHighlightType'}),
		];

		promises.push();
		promises = promises.map(p => p.then(resp => resp.json()));

		Promise.all(promises)
			.catch(exc => Promise.reject('(make sure browser CORS flag is set and cookie has the prod token) ' + exc))
			.then(([cmsData, gdses, langs, groups, colors, types]) => {
				return fetch(destinationUrl, {
					method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
						cmsData: cmsData, emcSessionId: emcSessionId,
						langs, gdses, groups, colors, types,
					}),
				})
			})
			.then(resp => resp.text())
			.then(resp => {
				document.querySelector('.multi-threading-test-output').innerHTML += 'Response: <br/>';
				document.querySelector('.multi-threading-test-output').innerText += resp;
				document.querySelector('.multi-threading-test-output').innerHTML += '<br/>';
			})
			.catch(exc => {
				document.querySelector('.multi-threading-test-output').innerHTML +=
					'<div style="color: red;">ERROR, ' + exc + '</div>';
			});
	};
</script>

</body>

<style>
	td, th {
		padding: 0px;
	}
	table {
	    border-collapse: collapse;
	    border-spacing: 0;
	}
</style>

</html>
